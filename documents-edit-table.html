<dom-module id="documents-edit-table">
	<style include="main-styles">
		:host {
			position: relative;
		}

		paper-fab {
			position: fixed;
			right: 24px;
			bottom: 24px;
			z-index: 1;
		}
	</style>
	<template>
		<paper-fab icon="add" title="Добавить" on-click="addDialog"></paper-fab>
		<table class="table">
			<tr>
				<th>Заголовок</th>
				<th></th>
			</tr>
			<template is="dom-repeat" items="[[items]]">
				<tr>
					<td>[[getTitle(item)]]</td>
					<td>
						<paper-icon-button icon="editor:mode-edit" on-click="editDialog"></paper-icon-button>
						<template is="dom-if" if="[[item.deleted]]">
							<span hidden>[[item]]</span>
							<paper-icon-button icon="undo" on-click="undoDialog"></paper-icon-button>
						</template>
						<template is="dom-if" if="[[!item.deleted]]">
							<span hidden>[[item]]</span>
							<paper-icon-button icon="delete" on-click="deleteDialog"></paper-icon-button>
						</template>
					</td>
				</tr>
			</template>
		</table>
	</template>
	<script>
		Polymer({
			is: 'documents-edit-table',
			attached: function () {
				var view = this;
				this.model = typeof this.model == 'string' ? eval(this.model) : this.model;
				this.model.read().then(function (items) {
					view.items = items;
				}).catch(err);
			},
			addDialog: function () {
				var view = this;
				var item = new this.model({});
				util.modalForm('Добавление документа', this.model.schema, item, function () {
					item.save().then(function (item) {
						view.push('items', item);
						util.notify('Документ добавлен');
					}).catch(err);
				});
			},
			editDialog: function (e) {
				var view = this;
				var item = e.model.item;
				util.modalForm('Добавление документа', this.model.schema, item, function () {
					item.save().then(function (item) {
						util.notify('Документ сохранён');
					}).catch(err);
				});
			},
			deleteDialog: function (e) {
				var view = this;
				var item = e.model.item;
				if (view.model.schema.safeDelete) {
					item.delete().then(function () {
						util.notify('Документ архивирован');
						view.set(['items', view.items.indexOf(item), 'deleted'], true);
					}).catch(err);
				} else if (confirm('Удалить документ? Это действие нельзя будет отменить.')) {
					item.delete().then(function () {
						util.notify('Документ удалён');
						view.splice('items', view.items.indexOf(item), 1);
					}).catch(err);
				}
			},
			undoDialog: function (e) {
				var view = this;
				var item = e.model.item;
				item.deleted = false;
				item.save().then(function () {
					util.notify('Документ восстановлен');
					view.set(['items', view.items.indexOf(item), 'deleted'], false);
				}).catch(err)
			},
			getTitle: function (item) {//todo: потом надо будет сделать настраиваемый через схему заголовок таблицы
				return item.name || item.shortname || item.shortName || item.short_name || item.fullname || item.fullName || item.full_name || item.title || item.text || item.value || item._id;
			}
		})
	</script>
</dom-module>
